<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.N.R Dashboard - NA Block</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg: #2b2b2b;
            --card-bg: #353535;
            --heading-white: #ffffff;
            --educational-blue: #00e5ff;
            --educational-purple: #bd93f9;
            --text: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 5px;
            height: 100vh;
            overflow: hidden; /* Prevents scrolling */
            display: flex;
            flex-direction: column;
        }

        /* Compact Header */
        .header-title {
            text-align: center;
            color: var(--heading-white);
            font-size: 1.2rem;
            margin: 5px 0;
            text-transform: uppercase;
            font-weight: 800;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 10px;
            flex: 1;
            padding: 5px;
            max-height: 85vh;
        }

        #reportCapture {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Professional Colored Fonts */
        .sec-col { color: var(--educational-blue); font-weight: bold; }
        .total-col { color: #f8f8f2; }
        .men-col { color: var(--educational-purple); font-size: 0.7rem; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th {
            background: #444;
            color: #fff;
            padding: 8px;
            border-bottom: 2px solid #555;
        }

        td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #444;
        }

        .abs-input {
            width: 35px;
            background: #111;
            border: 1px solid #555;
            color: #ff5555;
            text-align: center;
            font-weight: bold;
        }

        .chart-container {
            background: #333;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            padding: 5px 15px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .official-note {
            background: rgba(255, 85, 85, 0.1);
            border-left: 3px solid #ff5555;
            padding: 8px;
            font-size: 0.7rem;
            color: #ffaaaa;
            margin-top: 5px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .btn-upload { background: #6272a4; color: white; }
        .btn-ss { background: #50fa7b; color: #282a36; }
    </style>
</head>
<body>

    <h2 class="header-title">NA Block 1st Year Attendance Report</h2>

    <div class="controls-row">
        <div>
            <label style="font-size: 0.7rem;">Auto-Scan Image: </label>
            <input type="file" id="imageUpload" accept="image/*" class="btn btn-upload">
        </div>
        <button class="btn btn-ss" onclick="takeScreenshot()">Download Report</button>
    </div>

    <div class="main-container">
        <div id="reportCapture">
            <table>
                <thead>
                    <tr>
                        <th>SECTION</th>
                        <th>STRENGTH</th>
                        <th>ABSENT</th>
                        <th>%</th>
                        <th>MENTOR</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
                <tr style="background:#222; font-weight: bold;">
                    <td>TOTAL</td>
                    <td id="gStr">492</td>
                    <td id="gAbs" style="color:#ff5555;">0</td>
                    <td id="gPerc" style="color:#50fa7b;">100%</td>
                    <td>-</td>
                </tr>
            </table>

            <div class="official-note">
                ⚠️ OFFICIAL: Mentors must verify and submit the above PCR attendance immediately. 
            </div>
        </div>

        <div class="chart-container">
            <canvas id="attendanceChart"></canvas>
        </div>
    </div>

    <script>
        const data = [
            { n: "CSE-C", s: 60, m: "Yogesh/Anusuya" },
            { n: "CSE-D", s: 62, m: "Adrish/Govind" },
            { n: "CSE-E", s: 58, m: "Sukanya/Pradeep" },
            { n: "CSM-A", s: 63, m: "Shivani/K.Shivani" },
            { n: "IT-A", s: 49, m: "Alpana/Sujith" },
            { n: "ECE-A", s: 69, m: "Sumayyah/Sainath" },
            { n: "ECE-B", s: 69, m: "Muzammil/Anusha" },
            { n: "DS", s: 62, m: "Subhasish/Jayanthi" }
        ];

        let chart;

        function init() {
            const body = document.getElementById('tableBody');
            data.forEach((c, i) => {
                body.innerHTML += `
                    <tr>
                        <td class="sec-col">${c.n}</td>
                        <td class="total-col">${c.s}</td>
                        <td><input type="number" class="abs-input" id="abs-${i}" value="0" oninput="update()"></td>
                        <td id="p-${i}" style="font-weight:bold;">100%</td>
                        <td class="men-col">${c.m}</td>
                    </tr>
                `;
            });
            setupChart();
            update();
        }

        function update() {
            let tS = 0, tA = 0;
            const percentages = [];
            data.forEach((c, i) => {
                let a = parseInt(document.getElementById(`abs-${i}`).value) || 0;
                let p = ((c.s - a) / c.s) * 100;
                document.getElementById(`p-${i}`).innerText = p.toFixed(1) + "%";
                tS += c.s; tA += a;
                percentages.push(p.toFixed(1));
            });
            document.getElementById('gAbs').innerText = tA;
            document.getElementById('gPerc').innerText = (((tS - tA) / tS) * 100).toFixed(1) + "%";
            chart.data.datasets[0].data = percentages;
            chart.update();
        }

        function setupChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.n),
                    datasets: [{
                        label: 'Attendance %',
                        data: Array(8).fill(100),
                        backgroundColor: '#00e5ff'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { min: 0, max: 100, ticks: { color: '#fff' } }, y: { ticks: { color: '#fff' } } }
                }
            });
        }

        // IMAGE OCR LOGIC
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Tesseract.recognize(file, 'eng').then(({ data: { text } }) => {
                data.forEach((c, i) => {
                    // Regex looks for "SectionName" followed by a number in brackets, e.g., "CSE-C (5)" or "CSE-C 5"
                    const regex = new RegExp(`${c.n}.*?\\(?(\\d+)\\)?`, 'i');
                    const match = text.match(regex);
                    if (match) {
                        document.getElementById(`abs-${i}`).value = match[1];
                    }
                });
                update();
            });
        });

        function takeScreenshot() {
            html2canvas(document.body, { backgroundColor: '#2b2b2b' }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'NA_Block_SinglePage_Report.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        init();
    </script>
</body>
</html>
